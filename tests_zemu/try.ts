import Eth from '@ledgerhq/hw-app-eth'
import TransportNodeHid from '@ledgerhq/hw-transport-node-hid'
// import ledger_logs from '@ledgerhq/logs'
import { log } from '@ledgerhq/logs'
import AvalancheApp from '@zondax/ledger-avalanche-app'

const APP_DERIVATION = "m/44'/9000'/0'/0/0"
const ETH_DERIVATION = "m/44'/60'/0'/0'"

const ADD_DELEGATOR_DATA = Buffer.from([
  0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x30, 0x39, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0xdb, 0xcf, 0x89, 0x0f, 0x77, 0xf4, 0x9b, 0x96, 0x85, 0x76, 0x48, 0xb7, 0x2b, 0x77, 0xf9, 0xf8, 0x29, 0x37, 0xf2, 0x8a, 0x68, 0x70, 0x4a,
  0xf0, 0x5d, 0xa0, 0xdc, 0x12, 0xba, 0x53, 0xf2, 0xdb, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0xee, 0x5b, 0xe5, 0xc0, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0xda, 0x2b, 0xee, 0x01, 0xbe, 0x82, 0xec, 0xc0, 0x0c,
  0x34, 0xf3, 0x61, 0xed, 0xa8, 0xeb, 0x30, 0xfb, 0x5a, 0x71, 0x5c, 0x00, 0x00, 0x00, 0x01, 0xdf, 0xaf, 0xbd, 0xf5, 0xc8, 0x1f, 0x63, 0x5c,
  0x92, 0x57, 0x82, 0x4f, 0xf2, 0x1c, 0x8e, 0x3e, 0x6f, 0x7b, 0x63, 0x2a, 0xc3, 0x06, 0xe1, 0x14, 0x46, 0xee, 0x54, 0x0d, 0x34, 0x71, 0x1a,
  0x15, 0x00, 0x00, 0x00, 0x01, 0xdb, 0xcf, 0x89, 0x0f, 0x77, 0xf4, 0x9b, 0x96, 0x85, 0x76, 0x48, 0xb7, 0x2b, 0x77, 0xf9, 0xf8, 0x29, 0x37,
  0xf2, 0x8a, 0x68, 0x70, 0x4a, 0xf0, 0x5d, 0xa0, 0xdc, 0x12, 0xba, 0x53, 0xf2, 0xdb, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x01, 0xd2, 0x97,
  0xb5, 0x48, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe9, 0x09, 0x4f, 0x73, 0x69, 0x80, 0x02, 0xfd,
  0x52, 0xc9, 0x08, 0x19, 0xb4, 0x57, 0xb9, 0xfb, 0xc8, 0x66, 0xab, 0x80, 0x00, 0x00, 0x00, 0x00, 0x5f, 0x21, 0xf3, 0x1d, 0x00, 0x00, 0x00,
  0x00, 0x5f, 0x49, 0x7d, 0xc6, 0x00, 0x00, 0x01, 0xd1, 0xa9, 0x4a, 0x20, 0x00, 0x00, 0x00, 0x00, 0x01, 0xdb, 0xcf, 0x89, 0x0f, 0x77, 0xf4,
  0x9b, 0x96, 0x85, 0x76, 0x48, 0xb7, 0x2b, 0x77, 0xf9, 0xf8, 0x29, 0x37, 0xf2, 0x8a, 0x68, 0x70, 0x4a, 0xf0, 0x5d, 0xa0, 0xdc, 0x12, 0xba,
  0x53, 0xf2, 0xdb, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x01, 0xd1, 0xa9, 0x4a, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x3c, 0xb7, 0xd3, 0x84, 0x2e, 0x8c, 0xee, 0x6a, 0x0e, 0xbd, 0x09, 0xf1, 0xfe, 0x88, 0x4f,
  0x68, 0x61, 0xe1, 0xb2, 0x9c, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
  0x00, 0x01, 0xda, 0x2b, 0xee, 0x01, 0xbe, 0x82, 0xec, 0xc0, 0x0c, 0x34, 0xf3, 0x61, 0xed, 0xa8, 0xeb, 0x30, 0xfb, 0x5a, 0x71, 0x5c,
])

async function signAvax(app: AvalancheApp) {
  const signers = ['0/0', '0/1', '1/100']
  const resp = await app.sign("m/44'/9000'/0'", signers, ADD_DELEGATOR_DATA)
  console.log(resp)
}

async function get_avax_address(app: AvalancheApp) {
  const resp = await app.getAddressAndPubKey(APP_DERIVATION, true)
  console.log(resp)
}

async function sign_191_message(app: Eth) {
  // Initialize array to hold the message content
  const msgRaw: number[] = []
  // Add content following the same pattern as the Rust test
  msgRaw.push(...Buffer.from('Hello, ', 'utf8'))
  msgRaw.push(0x80)
  msgRaw.push(...Buffer.from('World! ', 'utf8'))
  msgRaw.push(0x81)
  msgRaw.push(...Buffer.from('This is a ', 'utf8'))
  msgRaw.push(0x82)
  msgRaw.push(...Buffer.from('complex ', 'utf8'))
  msgRaw.push(0x83)
  msgRaw.push(...Buffer.from('test ', 'utf8'))
  msgRaw.push(0x84)
  msgRaw.push(...Buffer.from('vector with ', 'utf8'))
  msgRaw.push(0x85, 0x86, 0x87)
  msgRaw.push(...Buffer.from(' multiple non-ASCII ', 'utf8'))
  msgRaw.push(0x88, 0x89)
  msgRaw.push(...Buffer.from(' characters ', 'utf8'))
  msgRaw.push(0x8a)
  msgRaw.push(...Buffer.from('scattered ', 'utf8'))
  msgRaw.push(0x8b)
  msgRaw.push(...Buffer.from('throughout. ', 'utf8'))
  msgRaw.push(0x8c, 0x8d, 0x8e, 0x8f)
  msgRaw.push(...Buffer.from('It should ', 'utf8'))
  msgRaw.push(0x90)
  msgRaw.push(...Buffer.from('properly ', 'utf8'))
  msgRaw.push(0x91)
  msgRaw.push(...Buffer.from('chunk ', 'utf8'))
  msgRaw.push(0x92)
  msgRaw.push(...Buffer.from('and format.', 'utf8'))

  const msgData = Buffer.from(msgRaw)
  const respReq = await app.signPersonalMessage(ETH_DERIVATION, msgData.toString('hex'))
  console.log('done!')
}

async function main() {
  const transport = await TransportNodeHid.create() // Changed from .open(null)

  log('trying to connect to device')

  const app = new Eth(transport)
  // await get_avax_address(new AvalancheApp(transport))
  await sign_191_message(app)
  // await signAvax(new AvalancheApp(transport))
}

;(async () => {
  await main().catch(console.error)
})()
